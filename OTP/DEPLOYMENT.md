# Vercel deployment checklist

The project is now configured to run inside a single Vercel serverless function that
wraps the Express application. Follow these steps to ensure production builds work
and that authentication state, user accounts, and CRM data continue to persist in
your PostgreSQL database.

## 1. Project settings

The repository now ships with a root-level `vercel.json` that changes into the
`OTP/` folder for both the install and build steps, so you can leave Vercel's
**Root Directory** blank (or explicitly set it to the repository root). The same
file disables framework auto-detection entirely, which stops the platform from
trying to auto-detect Next.js and eliminates the "No Next.js version detected"
build failure.

## 2. Build output

The Vite client build emits into `server/public`, and the Vercel function bundles
those files automatically. The same build command also runs the `esbuild` step
that produces the server bundle in `dist/`, which is now packaged with the
serverless function. Keep the default `npm run build` command so that `vite`
finishes before the server bundle is produced.

## 3. Environment variables

Configure the deployment with the same values you use locally:

- `DATABASE_URL` – PostgreSQL connection string (Supabase-compatible). Required
  for all queries and for the session store.
- `postgresql` – Optional alias generated by Supabase. If you paste their
  auto-generated `.env` block without renaming the variable, the server will
  still pick it up.
- `SESSION_SECRET` – secret used to sign session cookies. Needed so login and
  registration continue to work between requests.
- `TWILIO_*`, `NEXT_PUBLIC_*`, or any other third-party keys you rely on in the
  client or server runtime.

These variables must be added in the Vercel dashboard under **Settings → Environment
Variables** for the project. Re-deploy after saving changes.

Vercel already sets `NODE_ENV=production` for build and runtime environments, so
omit the variable entirely unless you have a compelling reason to override it.
Leaving `NODE_ENV=development` in your production secrets forces Express to try
booting the Vite development middleware, which is incompatible with the
serverless function.

## 4. Database persistence

Users, leads, activities, and related CRM records are inserted via the
`DatabaseStorage` class in `server/storage.ts`, which uses Drizzle ORM on top of
the pooled PostgreSQL connection provided by `server/db.ts`. As long as the
`DATABASE_URL` points to the same database, accounts created in Vercel are stored
persistently, and login/auth flows will read/write data just like in local
development.

## 5. Static asset handling

`vercel.json` rewrites every request to `api/index`, and `api/index.ts` exports the
Express app. On the Vercel platform `process.env.VERCEL` is set, so
`server/index.ts` skips booting an HTTP listener and instead serves pre-built
static assets directly from `server/public` inside the function. No additional
routing rules are necessary for client-side navigation.

If you deploy the same build to a host that _does_ run a long-lived Node
process, the Express bootstrap binds to `process.env.PORT` (falling back to
`5000` locally). That port number is ignored on Vercel because the handler is
invoked per-request rather than by opening a socket.

## 6. Limitations

The WebSocket bootstrap is disabled in serverless mode, so any realtime features
that rely on the long-lived socket will not be available on Vercel. For those
features you will need a separate service that supports persistent connections.

## 7. Troubleshooting build failures

- **"No Next.js version detected"** – ensure you are using the repository root as
  the project directory. The included `vercel.json` already switches into the
  `OTP/` folder for install/build commands and disables framework auto-detection.
- **"Unsupported runtime value"** – the `api/index.ts` function is configured for
  the standard `nodejs` runtime. If you see this error, double-check that you
  have not overridden the runtime setting in the Vercel dashboard.
- **Build succeeds but deployment returns 404** – confirm that `npm run build`
  finished both the Vite client build and the `esbuild` server bundle. The
  packaged function uploads `OTP/server/public/**` and `OTP/dist/**`; deleting
  either output directory before the deployment completes will result in an
  empty bundle.
